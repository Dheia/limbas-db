<?php
/**
 * @copyright Limbas GmbH <https://limbas.com>
 * @license https://opensource.org/licenses/GPL-2.0 GPL-2.0
 *
 * This program is free software; you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.
 * This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.
 */



class CLimbasSoapFactory {
	/**
	 * @var CLimbasSoapFactory static .
	 */
	private static $_instance = null;
	
	private $objects = array();
	
	public function createTable($name) {
		$name = ucfirst(lmb_strtolower($name));
		if (!isset($this->objects[$name])) {
			$this->objects[$name] = new $name();
		}
		return clone $this->objects[$name];
	}

	public function createArray($name) {
		$name = ucfirst(lmb_strtolower($name));
		$name .= 'Array';
		if (!isset($this->objects[$name])) {
			$this->objects[$name] = new $name();
		}
		return clone $this->objects[$name];
	}

	public function createQuery($name) {
		$name = ucfirst(lmb_strtolower($name));
		$name .= 'Query';
		if (!isset($this->objects[$name])) {
			$this->objects[$name] = new $name();
		}
		return clone $this->objects[$name];
	}

	public function createJoin($name) {
		$name = ucfirst(lmb_strtolower($name));
		$name .= 'Join';
		if (!isset($this->objects[$name])) {
			$this->objects[$name] = new $name();
		}
		return clone $this->objects[$name];
	}

	/**
	 * Static method which returns the singleton instance of this class.
	 *
	 * @return CLdapServer
	 */
	public static function getInstance() {
		if (is_null(self::$_instance)) {
			self::$_instance = new CLimbasSoapFactory();
		}
		return self::$_instance;
	}
	
	protected function __construct() {
		spl_autoload_register(array($this, 'autoload'));
	}
	
	public function autoload($className) {
		if (!file_exists(TEMPPATH . 'wsdl/models/' . $className . '.class')) { 
			$this->generateClassFile($className); 
		}
		require_once TEMPPATH . 'wsdl/models/' . $className . '.class';
		return true;
	}

	private function generateClassFile($className) {
		#error_log('Factory: ' . $className);
		$date = date(DATE_RSS);
		$filename = TEMPPATH . 'wsdl/models/' . $className . '.class';
		$fh = fopen($filename, 'w+');
		if (false !== $fh) {
			if (false !== lmb_strpos($className, 'Array')) {
				fwrite($fh, <<<EOS
<?php
/*
 * Generated by CLimbasSoapFactory
* Tue, 04 Jun 2013 14:32:02 +0200
*/
class $className {
	public \$items = array();
}
EOS
);
				fclose($fh);
			} else {
				if (false !== lmb_strpos($className, 'Query')) {
					$tableName = lmb_strtoupper(lmb_substr($className, 0, lmb_strlen($className) - 5));
					$baseClass = 'CLimbasSoapQuery';
				}		
				elseif (false !== lmb_strpos($className, 'Join')) {
					$tableName = lmb_strtoupper(lmb_substr($className, 0, lmb_strlen($className) - 4));
					$baseClass = 'CLimbasSoapJoin';		
				}
				else {
					$tableName = lmb_strtoupper($className);
					$baseClass = 'CLimbasSoapTable';
				}
			
				fwrite($fh, <<<EOS
<?php
/*
 * Generated by CLimbasSoapFactory
 * $date
 */
class $className extends $baseClass {
	public function __construct()
	{
		parent::__construct('$tableName');
	}
	public function __set(\$name, \$value)
	{
		if (\$this->attributes === array()) {
			\$this->table = '$tableName';
			\$this->createAttributes();
		}
		parent::__set(\$name, \$value);
	}
}
EOS
);
				fclose($fh);				
			}
		}
		else {
			throw new RuntimeException('Unable to open class file "' . $filename . '"!');
		}
	}
	/**
	 * Is there an instance of this class?
	 *
	 * @return boolean whether the instance was created or not
	 */
	public static function hasInstance() {
		return !is_null(self::$_instance);
	}
	
	/**
	 * Don't allow cloning of this class from outside
	 */
	private function __clone() {}
	}
